#include "ns3/core-module.h"
#include "ns3/network-module.h"
#include "ns3/internet-module.h"
#include "ns3/applications-module.h"
#include "ns3/netanim-module.h"
#include "ns3/point-to-point-module.h"

using namespace ns3;

NS_LOG_COMPONENT_DEFINE ("TcpCongestionExample");

// Congestion window change callback
static void
CwndChange (Ptr<OutputStreamWrapper> stream,
            uint32_t oldCwnd,
            uint32_t newCwnd)
{
  // Time (s)   NewCwnd (in KB)
  *stream->GetStream () << Simulator::Now ().GetSeconds ()
                        << "\t" << (double)newCwnd / 1024.0
                        << std::endl;
}

int
main (int argc, char *argv[])
{
  CommandLine cmd;
  cmd.Parse (argc, argv);

  // (Optional) TCP variant select â€“ e.g., NewReno
  Config::SetDefault ("ns3::TcpL4Protocol::SocketType",
                      TypeIdValue (TcpNewReno::GetTypeId ()));

  NodeContainer nodes;
  nodes.Create (2);

  PointToPointHelper p2p;
  p2p.SetDeviceAttribute ("DataRate", StringValue ("10Mbps"));
  p2p.SetChannelAttribute ("Delay", StringValue ("2ms"));

  NetDeviceContainer devices = p2p.Install (nodes);

  // Optional traces for link
  AsciiTraceHelper ascii;
  p2p.EnableAsciiAll (ascii.CreateFileStream ("tcp-link.tr"));
  p2p.EnablePcapAll ("tcp-congestion", true);

  InternetStackHelper stack;
  stack.Install (nodes);

  Ipv4AddressHelper address;
  address.SetBase ("10.1.1.0", "255.255.255.0");
  Ipv4InterfaceContainer interfaces = address.Assign (devices);

  uint16_t port = 9;
  Address sinkAddress (InetSocketAddress (interfaces.GetAddress (1), port));
  PacketSinkHelper sinkHelper ("ns3::TcpSocketFactory", sinkAddress);
  ApplicationContainer sinkApp = sinkHelper.Install (nodes.Get (1));
  sinkApp.Start (Seconds (0.5));
  sinkApp.Stop (Seconds (20.0));

  BulkSendHelper source ("ns3::TcpSocketFactory", sinkAddress);
  source.SetAttribute ("MaxBytes", UintegerValue (0)); // 0 = unlimited
  ApplicationContainer sourceApp = source.Install (nodes.Get (0));
  sourceApp.Start (Seconds (1.0));
  sourceApp.Stop (Seconds (20.0));

  Ptr<OutputStreamWrapper> cwndStream =
      ascii.CreateFileStream ("cwnd-trace.dat");

  // Attach to first TCP socket of node 0
  Config::ConnectWithoutContext (
      "/NodeList/0/$ns3::TcpL4Protocol/SocketList/0/CongestionWindow",
      MakeBoundCallback (&CwndChange, cwndStream));

  AnimationInterface anim ("tcp-congestion.xml");
  anim.SetConstantPosition (nodes.Get (0), 0.0, 0.0);
  anim.SetConstantPosition (nodes.Get (1), 50.0, 0.0);
  anim.UpdateNodeDescription (nodes.Get (0), "TCP Sender");
  anim.UpdateNodeDescription (nodes.Get (1), "TCP Receiver");
  anim.UpdateNodeColor (nodes.Get (0), 0, 255, 0);
  anim.UpdateNodeColor (nodes.Get (1), 0, 0, 255);

  Simulator::Stop (Seconds (20.0));
  Simulator::Run ();
  Simulator::Destroy ();
  return 0;
}

